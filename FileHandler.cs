namespace uwap.WebFramework.Plugins;

public partial class FilePlugin : Plugin
{
	public override byte[]? GetFile(string relPath, string pathPrefix, string domain)
		=> relPath switch
		{
			"/edit-d.js" => System.Text.Encoding.UTF8.GetBytes($"async function AddNode(d) {{\n    try {{\n        var n = encodeURIComponent(document.querySelector(\"#name\").value);\n        if (n === \"\")\n        {{\n            ShowError(\"Enter a name.\");\n            return;\n        }}\n        var u = GetQuery(\"u\");\n        var p = encodeURIComponent(GetQuery(\"p\"));\n        switch ((await fetch(`/api{pathPrefix}/add?u=${{u}}&p=${{p}}&n=${{n}}&d=${{d}}`)).status) {{\n            case 200:\n                window.location.assign(`{pathPrefix}/edit?u=${{u}}&p=${{p}}%2f${{n}}`)\n                break;\n            case 302:\n                ShowError(\"Another file or directory with this name already exists.\");\n                break;\n            default:\n                ShowError(\"Connection failed.\");\n                break;\n        }}\n    }} catch {{\n        ShowError(\"Connection failed.\");\n    }}\n}}"),
			"/editor.js" => System.Text.Encoding.UTF8.GetBytes($"let ch = 0;\nlet ta = document.querySelector('#text');\nlet editor = document.querySelector('#editor');\nlet sidebar = document.querySelector('.sidebar');\nlet full = document.querySelector('.full');\nlet save = document.querySelector('#save');\nlet back = document.querySelector('#back');\nwindow.onresize = Resize;\nta.onclick = Refocus;\nResize();\nLoad();\ndocument.addEventListener('keydown', e => {{\n    if (e.ctrlKey && e.key === 's') {{\n        e.preventDefault();\n        Save();\n    }}\n}});\n\nfunction Resize() {{\n    let fullComp = window.getComputedStyle(full);\n    let editorComp = window.getComputedStyle(editor);\n    let newHeight = Math.floor(window.visualViewport.height - parseFloat(editorComp['marginTop']) - parseFloat(fullComp['paddingTop']) - parseFloat(fullComp['paddingBottom']));\n    editor.style.flex = '1';\n    editor.style.height = newHeight + 'px';\n    Refocus();\n}}\n\nfunction Refocus() {{\n    let nh = ta.clientHeight;\n    if (ch > nh && document.activeElement === ta) {{\n        ta.blur();\n        ta.focus();\n    }}\n    ch = nh;\n}}\n\nasync function Load() {{\n    try {{\n        let response = await fetch(`/api{pathPrefix}/load?u=${{GetQuery(\"u\")}}&p=${{encodeURIComponent(GetQuery(\"p\"))}}`);\n        switch (response.status) {{\n            case 200:\n                ta.value = await response.text();\n                ta.placeholder = \"Enter something...\";\n                break;\n            case 201:\n                ta.value = \"\";\n                ta.placeholder = \"Enter something...\";\n                ta.focus();\n                break;\n            default:\n                ta.value = \"\";\n                ta.placeholder = \"Error loading this file's content! Try reloading the page.\";\n                save.innerText = \"Error!\";\n                save.className = \"red\";\n        }}\n    }} catch {{\n        ta.value = \"\";\n        ta.placeholder = \"Error loading this file's content! Try reloading the page.\";\n        save.innerText = \"Error!\";\n        save.className = \"red\";\n    }}\n}}\n\nfunction TextChanged() {{\n    save.innerText = \"Save\";\n    save.className = \"green\";\n}}\n\nasync function Save() {{\n    back.innerText = \"Back\";\n    save.innerText = \"Saving...\";\n    save.className = \"green\";\n    try {{\n        if ((await fetch(`{pathPrefix}/save?u=${{GetQuery(\"u\")}}&p=${{encodeURIComponent(GetQuery(\"p\"))}}`, {{ method: \"POST\", body: ta.value }})).status === 200) {{\n            save.innerText = \"Saved!\";\n            save.className = \"\";\n        }} else {{\n            save.innerText = \"Error!\";\n            save.className = \"red\";\n        }}\n    }} catch {{\n        save.innerText = \"Error!\";\n        save.className = \"red\";\n    }}\n}}\n\nfunction GoTo(url) {{\n    if (save.innerText === \"Save\")\n        save.className = \"red\";\n    else window.location.assign(url);\n}}\n\nfunction GoBack(url) {{\n    if (save.innerText === \"Save\" && back.innerText == \"Back\")\n        back.innerText = \"Discard?\";\n    else window.location.assign(url);\n}}"),
			"/query.js" => (byte[]?)PluginFiles_ResourceManager.GetObject("File0"),
			_ => null
		};
	
	public override string? GetFileVersion(string relPath)
		=> relPath switch
		{
			"/edit-d.js" => "1714262881323",
			"/editor.js" => "1714321866805",
			"/query.js" => "1714256773673",
			_ => null
		};
	
	private static readonly System.Resources.ResourceManager PluginFiles_ResourceManager = new("FilePlugin.Properties.PluginFiles", typeof(FilePlugin).Assembly);
}